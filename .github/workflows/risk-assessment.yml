name: Risk Assessment

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches: [ main, develop ]

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  assess-risk:
    name: Assess PR Risk
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Need full history for commit analysis
        
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'
        
    - name: Install RiskAssessor
      run: |
        python -m pip install --upgrade pip
        pip install -e .
        pip install -r requirements.txt
        
    - name: Run Risk Assessment
      id: risk-assessment
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        GITHUB_REPO: ${{ github.repository }}
        # Note: For LLM analysis, you would need to set OPENAI_API_KEY as a secret
        # For now, the assessment will work without LLM (using complexity + history only)
      run: |
        # Get the base and head refs for this PR
        BASE_REF="${{ github.event.pull_request.base.sha }}"
        HEAD_REF="${{ github.event.pull_request.head.sha }}"
        PR_NUMBER="${{ github.event.pull_request.number }}"
        
        echo "Assessing risk for PR #${PR_NUMBER}"
        echo "Base: ${BASE_REF}"
        echo "Head: ${HEAD_REF}"
        
        # Try to run with contract format first (v2.0)
        if python -m risk_assessor.cli assess-pr-contract --pr ${PR_NUMBER} --deployment-region "ci-validation" --output risk-contract.json 2>/dev/null; then
          echo "Generated risk contract"
          echo "risk_format=contract" >> $GITHUB_OUTPUT
        else
          # Fall back to legacy format or commits assessment
          echo "Falling back to commits assessment"
          python -m risk_assessor.cli assess-commits --base ${BASE_REF} --head ${HEAD_REF} --output risk-assessment.json || true
          echo "risk_format=legacy" >> $GITHUB_OUTPUT
        fi
        
        # Extract risk level for workflow status
        if [ -f risk-contract.json ]; then
          RISK_LEVEL=$(jq -r '.risk_summary.risk_level // "UNKNOWN"' risk-contract.json)
          RISK_SCORE=$(jq -r '.risk_summary.risk_score // 0' risk-contract.json)
        elif [ -f risk-assessment.json ]; then
          RISK_LEVEL=$(jq -r '.risk_level // "unknown"' risk-assessment.json | tr '[:lower:]' '[:upper:]')
          RISK_SCORE=$(jq -r '.overall_risk_score // 0' risk-assessment.json)
        else
          RISK_LEVEL="UNKNOWN"
          RISK_SCORE="0"
        fi
        
        echo "risk_level=${RISK_LEVEL}" >> $GITHUB_OUTPUT
        echo "risk_score=${RISK_SCORE}" >> $GITHUB_OUTPUT
        
        echo "Risk Level: ${RISK_LEVEL}"
        echo "Risk Score: ${RISK_SCORE}"
        
    - name: Generate Risk Summary
      id: summary
      run: |
        if [ -f risk-contract.json ]; then
          # Generate summary from contract format
          cat > risk-summary.md << 'EOF'
        ## ðŸŽ¯ Risk Assessment Report
        
        **Risk Level:** $(jq -r '.risk_summary.risk_level' risk-contract.json)
        **Risk Score:** $(jq -r '.risk_summary.risk_score' risk-contract.json)
        **Confidence:** $(jq -r '.risk_summary.confidence' risk-contract.json)
        
        ### ðŸ“Š Overall Assessment
        $(jq -r '.risk_summary.overall_assessment' risk-contract.json)
        
        ### ðŸ” Risk Factors
        $(jq -r '.factors[] | "- **\(.factor_name)**: \(.observed_value) (Weight: \(.weight))"' risk-contract.json)
        
        ### ðŸ’¡ Recommendations
        $(jq -r '.recommendations[] | "- \(.)"' risk-contract.json)
        
        ### ðŸ“ Text Summary
        $(jq -r '.text_summary' risk-contract.json)
        
        ---
        *Generated by RiskAssessor v2.0 - Contract ID: $(jq -r '.id' risk-contract.json)*
        EOF
          
          # Process the markdown to replace command substitutions
          eval "cat > risk-summary-final.md << 'EVALEOF'
        $(cat risk-summary.md)
        EVALEOF"
          
        elif [ -f risk-assessment.json ]; then
          # Generate summary from legacy format
          cat > risk-summary-final.md << 'EOF'
        ## ðŸŽ¯ Risk Assessment Report (Legacy Format)
        
        **Risk Level:** $(jq -r '.risk_level // "unknown"' risk-assessment.json | tr '[:lower:]' '[:upper:]')
        **Overall Risk Score:** $(jq -r '.overall_risk_score // 0' risk-assessment.json)
        
        ### ðŸ“Š Complexity Analysis
        - Files Changed: $(jq -r '.complexity_analysis.files_changed // 0' risk-assessment.json)
        - Additions: $(jq -r '.complexity_analysis.additions // 0' risk-assessment.json)
        - Deletions: $(jq -r '.complexity_analysis.deletions // 0' risk-assessment.json)
        - Complexity Score: $(jq -r '.complexity_analysis.complexity_score // 0' risk-assessment.json)
        
        ### ðŸ“š Historical Analysis
        - Related Issues: $(jq -r '.history_analysis.related_issues_count // 0' risk-assessment.json)
        - History Risk Score: $(jq -r '.history_analysis.history_risk_score // 0' risk-assessment.json)
        
        ---
        *Generated by RiskAssessor*
        EOF
          
          eval "cat > risk-summary-final.md << 'EVALEOF'
        $(cat risk-summary-final.md)
        EVALEOF"
        fi
        
    - name: Post Risk Assessment Comment
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          const riskLevel = '${{ steps.risk-assessment.outputs.risk_level }}';
          const riskScore = '${{ steps.risk-assessment.outputs.risk_score }}';
          
          let summary = '## ðŸŽ¯ Risk Assessment Report\n\n';
          
          if (fs.existsSync('risk-summary-final.md')) {
            summary = fs.readFileSync('risk-summary-final.md', 'utf8');
          } else {
            summary += `**Risk Level:** ${riskLevel}\n`;
            summary += `**Risk Score:** ${riskScore}\n\n`;
            summary += '*Risk assessment completed. See artifacts for full report.*\n';
          }
          
          // Add emoji based on risk level
          const emoji = {
            'LOW': 'âœ…',
            'MEDIUM': 'âš ï¸', 
            'HIGH': 'ðŸš¨',
            'CRITICAL': 'âŒ',
            'UNKNOWN': 'â“'
          }[riskLevel] || 'â“';
          
          const body = `${emoji} ${summary}`;
          
          // Check if a comment already exists
          const { data: comments } = await github.rest.issues.listComments({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: context.issue.number,
          });
          
          const botComment = comments.find(comment => 
            comment.user.type === 'Bot' && 
            comment.body.includes('Risk Assessment Report')
          );
          
          if (botComment) {
            // Update existing comment
            await github.rest.issues.updateComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: botComment.id,
              body: body
            });
          } else {
            // Create new comment
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: body
            });
          }
          
    - name: Upload Risk Assessment Artifacts
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: risk-assessment-${{ github.event.pull_request.number }}
        path: |
          risk-contract.json
          risk-assessment.json
          risk-summary-final.md
        retention-days: 30
        
    - name: Check Risk Level Threshold
      if: steps.risk-assessment.outputs.risk_level == 'HIGH' || steps.risk-assessment.outputs.risk_level == 'CRITICAL'
      run: |
        echo "::warning::High risk detected! Risk Level: ${{ steps.risk-assessment.outputs.risk_level }}"
        echo "This PR requires careful review and staged rollout."
        # Uncomment the following line to fail the workflow on HIGH risk
        # exit 1
